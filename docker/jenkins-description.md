# Launching a Jenkins first
- go to `localhost:8090`
- to unlock Jenkins, get password:
  - list all containers `docker container ls`
  - `docker exec <jenkins-container-name> cat /var/jenkins_home/secrets/initialAdminPassword`
- it's suggested to select option: Install suggested plugins 
- when all plugins installed successfully, create First Admin User
- on `Instance Configuration` page accept host name of your controller
- now, agents, jobs, and so on, can be setup

# Jenkins with Java 17 and jmapper-framework issue
This project uses Java 15 version, and Jenkins images support Java versions among others 11 and 17.
This situation causes problems when compiling projects. The only solution is to use the same Java version during code development and running CI pipeline:
- this is why Gradle image with Java 15 as a pipeline agent is used
- when running this image, default bridge network is used
- it's required to add a `docker pipeline plugin` in the Jenkins dashboard

# Jenkins and Google Jib
1. Add environment variables:
    - go to `Manage Jenkins` -> `Configure System` and find `Global properties`
    - Check `Environment Variables`
    - add variable: `SF_DATABASE_HOST=<your-postgres-db-host-name>`, for example `postgres`
    - add variable: `IMAGE_REGISTRY=<where-to-push-docker-image>`, for example `your-docker-hub-username/docker-hub-repo`
    - add variable: `EMAIL_TO=<email-to-send-info-about-build-failure>`
    - now go to `Manage Jenkins` -> `Manage Credentials` -> `Global credentials (unrestricted)` and click on `Add Credentials` 
    - add new database password as secret: `Secret text`, `Secret: <your-db-password>`, `ID: SPRING_DATASOURCE_PASSWORD`
    - add new Docker Hub credentials: `Username with password`, `Username: <your-docker-hub-username>`, `Username: <your-docker-hub-password>`, `ID: docker-hub`
      - in the pipeline there will be available two variables with `_USR` and `_PSW` prefixes (default generated by Jenkins)

# Configure Jenkins email handling
If using gmail, generate `application specific password`
- go to `Account Settings`
- go to `Security`
- add `App password`
Go to `Manage Jenkins` -> `Configure System`
Find `E-mail Notification`
- set `smtp server: smtp.gmail.com`
- select `Use SMTP Authentication`
  - provide email and `app password` generated earlier
- select `Use SSL`
- provide `SMTP Port: 465`
- Save it


# DIFFERED: Configure Jenkins agent
Because of problems with GitHub credentials, when using the Jenkins agent, this point is temporarily deferred.
Add to docker-compose file:
```yaml
  jenkins_agent:
    image: jenkins/ssh-agent:latest-jdk17
    privileged: true
    user: root
    restart: always
    container_name: $CONTAINER_NAME
    expose:
      - 22
    environment:
      - JENKINS_AGENT_SSH_PUBKEY=$JENKINS_AGENT_SSH_PUBKEY
    depends_on:
      - jenkins
```
1. Prepare SSH keys
   - since Jenkins Controller (master node), communicates with Jenkins Agents (slaves) via SSH, generate SSH keys:
     - `ssh-keygen -t rsa -f jenkins_agent`
     - this will produce, two files: private key and public key
   - go to the Jenkins web page, and select `Manage Jenkins` from the menu
   - go to `Manage Credentials`, click on the available store scoped to Jenkins (it might be called `Jenkins` or `System`, with `Global` domain), and finally, click on `Global credentials`
   - click on button `Add credentials` and: 
     - `Kind`:  SSH Username with private key
     - `Scope`: System. Thanks to that, this key won't be used by Jenkins jobs
     - `Id`: jenkins_agent
     - `Username`: provide your Jenkins account username (which you log in to Jenkins)
     - `Private Key` select Enter directly
     - Now provide contents of jenkins_file
     - Click `Create`
2. Add Jenkins agent should be defined in docker compose file
   - copy content of jenkins_file.pub into an environment variable (for example `$JENKINS_AGENT_SSH_PUBKEY`)
      ```yaml
          environment:
            - JENKINS_AGENT_SSH_PUBKEY=$JENKINS_AGENT_SSH_PUBKEY
      ```
   - run docker containers
3. Add Jenkins agent via Jenkins dashboard
   - go to Jenkins web page
   - go to `Manage Jenkins`, nextly `Manage Nodes and Clouds`
   - click on `New node`, provide a new node name, select `Permanent Agent` under `Type`
   - on the next page provide:
     - `Number of executors`: 1 (choose a different value when needed)
     - `Remote root directory`: /home/jenkins/agent
     - `Launch method`: Launch agents via SSH
     - `Host`: provide docker-compose service name
     - `Credentials`: select credentials prepared in point 1
     - `HostKeyVerificationStrategy`: Non verifying Verification Strategy
     - click on `Advanced` button
       - `Connection Timeout in Seconds`: 60
       - `Maximum Number of Retries`: 10
       - `Seconds To Wait Between Retries`: 20
     - click on `Save` button
4. Verify if Jenkins agent work
   - go to Jenkins web page
   - go to `Manage Jenkins`, nextly `Manage Nodes and Clouds`
   - select `jenkins_agent` from the list
   - click on `log` tab
   - at the bottom there should be a message: `Agent successfully connected and online`
   - if some `SSH` problems occur, make sure if environment variable `JENKINS_AGENT_SSH_PUBKEY` is properly set up. **OS restart might be required** 